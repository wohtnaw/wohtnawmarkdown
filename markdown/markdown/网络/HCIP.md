# RSTP
## STP

```plantuml
@startmindmap

right side

+ 生成树系列

++ 使用场景
+++ STP协议

++++ 缺点
+++++ 收敛慢
++++++ 30s/50s

+++++ 浪费资源
++++++ 会阻塞多余端口，多与端口完全不会跑数据


+++ RSTP协议

++++ 在STP基础上，改进了速度，变成了秒级

++++ 缺点
+++++ 浪费资源
++++++ 会阻塞多余端口，多与端口完全不会跑数据

++++ 使用场景
+++++ 中小型企业的业务


+++ MSTP协议

++++ 在RSTP基础上解决了资源浪费的问题，提高了流量利用率

++++ 缺点
+++++ 速度/利用率很普通

++++ 使用场景
+++++ 企业网络

+++ 堆叠/集群+聚合
++++ 主流虚拟化方案，毫秒级

++++ 缺陷
+++++ 只能自己厂家的设备做虚拟化，并且型号严格要求


++++ 使用场景
+++++ 各类场景部署都适用


++ STP原理
+++ 基础概念

++++ BID
+++++ 组成
++++++ 优先级+MAC地址

++++ RID
+++++ 根桥
+++++ 全网当中会选出唯一的根桥
+++++ 设备在传递BPDU的过程中，里面携带了根桥的BID，放在RID的参数当中

++++ COST
+++++ 计算到根桥的路径距离，用来进行选举比较的


++++ PORT
+++++ 优先级+端口

+++ 选举过程
++++ 选举参数
+++++ 最小的根桥ID
++++++ 优先级+MAC地址
++++++ 比较方式
+++++++ 1.先比较优先级，越小越优先
+++++++ 2.比较MAC地址

+++++ 最小的cost
++++++ 最小的根路径开销

+++++ 最小的BID
++++++ 优先级+MAC地址
++++++ 比较方式
+++++++ 1.先比较优先级，越小越优先
+++++++ 2.比较MAC地址

+++++ 最小的PORT ID

++++ 选举步骤
+++++ 1、全网当中选出唯一的根桥（老大）
++++++ 注意：全网初始情况下，所有人都认为自己是老大

+++++ 2、每个非根交换机选出唯一的一个根端口
++++++ 针对所有端口收到的BPDU进行比较

+++++ 3、每一段当中选出一个指定端口
++++++ 两台设备互相发送的BPDU进行比较

+++++ 4、没有角色的端口为阻塞端口

+++ 状态机
++++ 作用：防止出现临时环路
++++ 过程：侦听---15s---学习----15s---转发

+++ 故障切换
++++ 存在阻塞端口的设备出现链路故障
+++++ 根端口挂掉，等待30s完成收敛（阻塞端口是根端口的替代端口）

++++ 不存在阻塞端口的设备出现链路故障
+++++ 根端口挂掉后，等待50s后，完成收敛，20s的超时时间

left side

-- 配置命令
--- stp mode stp
---- 缺省情况下模式为mstp

--- stp priority 8192
---- 修改BID优先级为8192，缺省情况下是32768

--- stp cost 10000
---- 修改当前端口的stp cost参数为10000

--- display stp brief
---- 查看端口stp信息

@endmindmap
```
## RSTP 
### 概念
1. 在IEEE 802.1W中定义
2. 在许多方面对STP进行优化，收敛速度更快，而且兼容STP
3. 端口角色优化：增加两个端口角色

|RSTP端口角色|说明|备注|
|:-:|:-:|:-:|
|root port|根端口：去往根桥路径开销最小的端口||
|designed port|指定端口：向本网段转发配置消息的端口||
|alternate port|替代端口：学习其他网桥发送的BPDU报文而阻塞的端口|根端口的备份|
|backup port|备份端口：学习到自己发送的BPDU而阻塞的端口|指定端口的备份端口|

4. 端口状态优化：精简成3种状态

|STP端口状态|RSTP端口状态|学习mac地址|转发数据|
|:-:|:-:|:-:|:-:|
|Forwarding|Forwarding|是|是|
|Learning|Learning|是|否|
|Listening|Discarding|否|否|
|Blocking|Discarding|否|否|
|Disabled|Discarding|否|否|

5. 快速收敛机制
根端口快速切换：如果根端口失效，则最优的alternate端口成为根端口，进入forwarding状态

指定端口快速切换：如果指定端口失效，那么最优的backup端口将成为指定端口，进入forwarding状态

6. 边缘端口
边缘端口不参与RSTP计算，直接进入forwarding状态

但是，一旦边缘端口收到bpdu，就会丧失边缘端口属性，成为普通STP端口，并重新进行生成树计算，从而引起网络震荡
7. P/A机制：proposal/agreement
加快上游端口进入forwarding状态的速度

当一个端口被选举为指定端口后，会先进入discarding状态，然后通过P/A机制快速进入forwarding状态

P/A机制要求两台交换机之间链路必须是点到点的全双工模式，一旦P/A不成功，指定端口的选择就需要等待两个forward delay，协商过程与STP一样
8. 拓扑变更机制优化
RSTP拓扑变化唯一标准：一个非边缘端口切换到forwarding状态
9. RSTP对STP优化总结

|对比项|STP|RSTP|
|:-:|:-:|:-:|
|角色状态|5个|3个|
|端口角色|2个|4个|
|配置BPDU flag位使用|2位|4位|
|BPDU超时计时|maxage|hello\*3\*time factor|
|处理次优BPDU|等待超时|立即回应最优BPDU|
|稳定后BPDU发送方式|根桥发送|所有交换机|
|快速收敛|无|P/A机制|
|边缘端口|无|有|
|保护功能|无|4中保护机制|
# MSTP
## RSTP/STP的不足

1. 流量无法负载分担
2. 会产生二层次优路径

## MSTP协议概述

* MSTP是在IEEE 802.1S中定义的，兼容RSTP和STP，既可以快速收敛，又提供了数据转发的多个冗余路径，在数据转发过程中实现VLAN数据的负载均衡
* 可以将一个或多个VLAN实例（instance），再基于实例计算生成树，映射到同一个实例的VLAN共享同一棵生成树
## MSTP网络层次

1. MSTP把一个交换网络划分为多个域，每个域内生成多棵生成树，生成树之间互相独立

2. MST Region:多生成树域

* 由交换网络中的多台交换设备以及它们之间的网段构成
* 一个局域网内可以存在多个MST域，各个域之间在物理上直接或间接连接。可以通过MSTP配置命令把多台交换设备划分在同一个MST域中
* MSTP网络内包含一个或多个MST域，每个MST中包含一个或多个生成树实例

## MSTI

1. MSTI：多生成树实例

* 一个MSTP域中可以有多棵生成树，每棵生成树都称为一个MSTI
* MSTI使用instance id标识，华为设备取值为`0~4094`

2. VLAN映射表
MSTP域的属性，描述了VLAN和MSTI间的映射关系

## CST

* CST:公共生成树
* 是连接交换网络内所有的MST域的一棵生成树
* 如果把每个MST域看做一个节点，CST就是这些节点通过生成树协议计算生成的一棵生成树

## IST

* IST:内部生成树
* 是各MST域内的一棵生成树
* IST是一个特殊的MSTI，它的instance id为0

## CIST

* CIST:公共和内部生成树
* 通过生成树协议计算生成的，连接一个交换网络内所有交换设备的单生成树

## SST

1. SST:单生成树
2. 有两种情况：

* 运行生成树协议的交换设备只能属于一个生成树
* MSTP域中只有一个交换设备，这个交换设备构成单生成树

## MSTP网络中的交换机角色
1. 总根

是CIST的根桥

2. 域根

* 分为IST域根和MSTI域根
* IST域根：在MST域中IST生成树中距离总根最近的交换设备
* MSTI域根：每个多生成树实例的域根

3. 主桥

* 是IST Master，它是域内距离总根最近的交换设备
* 如果总根在MST域中，则总根为该域的主桥
# 链路聚合
## Eth-Trunk概念
1. Eth-Trunk是一种将多个以太网接口捆绑成一个逻辑接口的捆绑技术。
2. Eth-Trunk链路聚合模式：

* 手工负载分担模式
* LACP模式

## 手工负载分担模式
1. 当两台设备中至少有一台不支持LACP协议时，可使用手工负载分担模式的Eth-Trunk来增加设备间的带宽及可靠性。
2. 在手工负载分担模式下，加入Eth-Trunk的链路都进行数据的转发

## 配置手工负载分担模式
配置手工负载分担模式的步骤：

* 创建Eth-Trunk；
* 配置Eth-Trunk的工作模式；
* Eth-Trunk中加入成员接口

## LACP模式
LACP模式也称为M:N模式，其中M条链路处于活动状态转发数据，N条链路处于非活动状态作为备份链路

## LACP配置LACP模式
配置LACP模式的步骤：

* 创建Eth-Trunk；
* 配置Eth-Trunk的工作模式；
* Eth-Trunk中加入成员接口；
* （可选）配置系统LACP优先级；
* （可选）配置活动接口数上限阈值；
* （可选）配置接口LACP优先级；
* （可选）使能LACP抢占并配置抢占延时时间

## 负载分担

1. 基于包的负载分担

在使用Eth-Trunk转发数据时，由于聚合组两端设备之间有多条物理链路，如果每个数据帧在不同链路上转发，则有可能导致数据帧到达对端时间不一致，从而引发数据乱序

2. 基于流的负载分担

Eth-Trunk推荐采用流负载分担的方式，即一条相同的流负载到一条链路，这样既保证了同一数据流的数据帧在同一条物理链路转发，又实现了流量在聚合组内各种物理链路上的负载分担

这种分担模式可以选择按地址分类：源IP/源目IP/源MAC/源目MAC，默认是源目IP，可以通过`load-balence`来设置

# VLAN高级技术
## VLAN聚合
### VLAN聚合产生的技术背景

1. 在一般的三层交换机中，通常是采用一个VLAN对应一个VLANIF接口的方式实现广播域之间的互通，这在某些情况下导致了IP地址的浪费。

2. 因为一个VLAN对应的子网中，子网号、子网广播地址、子网网关地址不能用作VLAN内的主机IP地址，且子网中实际接入的主机可能少于可用IP地址数量，空闲的IP地址也会因不能再被其他VLAN使用而被浪费掉

### VLAN聚合概述

1. VLAN聚合（VLAN Aggregation，也称Super-VLAN）: 指在一个物理网络内，用多个VLAN（称为Sub-VLAN）隔离广播域，并将这些Sub-VLAN聚合成一个逻辑的VLAN（称为Super-VLAN），这些Sub-VLAN使用同一个IP子网和缺省网关，进而达到节约IP地址资源的目的。

2. Sub-VLAN：只包含物理接口，不能建立三层VLANIF接口，用于隔离广播域。每个Sub-VLAN内的主机与外部的三层通信是靠Super-VLAN的三层VLANIF接口来实现的。

3. Super-VLAN：只建立三层VLANIF接口，不包含物理接口，与子网网关对应。与普通VLAN不同，Super-VLAN的VLANIF接口状态取决于所包含Sub-VLAN的物理接口状态

### VLAN聚合的原理

每个Sub-VLAN对应一个广播域，多个Sub-VLAN和一个Super-VLAN关联，只给Super-VLAN分配一个IP子网，所有Sub-VLAN都使用Super-VLAN的IP子网和缺省网关进行三层通信

### VLAN聚合的应用

传统VLAN方式每一个VLAN需要划分不同的IP地址网段，在本例中需要耗费4个IP网段和产生4条路由条目；Super-VLAN方式只需要分配一个IP地址网段，下属二层VLAN共用同一个IP地址网段，共用同一个三层网关，同时VLAN之间保持二层隔离

### 相同Sub-VLAN内部通信

同一个Sub-VLAN之间属于同一个广播域，因此相同Sub-VLAN之间可以通过二层直接通信

### 不同Sub-VLAN之间通信举例

![](../../img/不同Sub-VLAN之间的通信.png)

Super-VLAN VLANIF100开启ARP代理之后PC1和PC2之间通信过程如下：

1. PC1发现PC2与自己在同一网段，且自己ARP表无PC2对应表项，则直接发送ARP广播请求PC2的MAC地址。

2. 作为网关的Super-VLAN对应的VLANIF 100收到PC1的ARP请求，由于网关上使能Sub-VLAN间的ARP代理功能，则向Super-VLAN 100的所有Sub-VLAN接口发送一个ARP广播，请求PC2的MAC地址。

3. PC2收到网关发送的ARP广播后，对此请求进行ARP应答。

4. 网关收到PC2的应答后，就把自己的MAC地址回应给PC1，PC1之后要发给PC2的报文都先发送给网关，由网关做三层转发。

### Sub-VLAN与其他设备的二层通信

* 当Sub-VLAN与其他设备进行二层通信时，与普通的VLAN内二层通信无区别。

* 由于Super-VLAN不属于任何物理接口，即不会处理任何携带Super-VLAN标签的报文
