# 数据通信网络基础

## 通信与网络

### 网络通信基本概念

**通信**：人与人、人与物、物与物之间通过某种媒介和行为进行的信息传递与交流

**网络通信**：终端设备之间通过计算机网络进行的通信

**信息传递过程**：虚拟的信息传递与真实的物品传递过程有许多相似之处

**常见术语**：

* 数据载荷

* 报文
 
* 头部
 
* 尾部
 
* 封装：对数据加上头尾部，形成新的报文的过程
 
* 解封装：去掉报文的头尾部，获取数据的过程
 
* 网关：提供协议转换、路由选择、数据交换等功能的网络设备
 
* 路由器：为报文选择传递路径的网络设备

* 终端设备
 
* PDU：协议数据单元

### 数据通信基本概念

数据通信网络：由路由器、交换机、防火墙、无线控制器、无线接入点，以及个人电脑、网络打印机、服务器等设备构成的通信网络

功能：数据通信网络最基本的功能是实现数据互通

**网络设备**：

1. 交换机：距离终端用户最近的设备，用于终端用户介入网络，对数据帧进行交换等，有二层和三层交换机

2. 路由器：网络层设备，可以在因特网中进行数据报文转发。路由器根据所收到的报文的目的地之选择一条合适的路径，将报文传送到下一个路由器或目的地，路径中最后的路由器负责将报文送交目的主机

* 实现同类型网络或异种类型网络之间的通信
* 隔离广播域

* 维护路由表、运行路由协议

* 路径（路由信息）选择、IP报文转发

* 广域网介入、网络地址转换
* 连接通过交换机组成的二层网络
3. 防火墙：网络安全设备，用于控制两个网络之间的安全通信。它通过监测、限制、更改跨越防火墙的数据流，尽可能地对外部屏蔽网络内部的信息、结构和运行状况，以此来实现对网络的安全保护

* 隔离不同安全级别的网络 
* 实现不同安全级别网络间的访问控制（安全策略） 
* 用户身份认证 
* 实现远程接入功能 
* 实现数据加密以及虚拟专用网业务 
* 执行网络地址转换 
* 其他安全功能

4. 无线设备：无线胖AP、无线瘦AP、AC

## 网络类型与网络拓扑

### 网络类型

根据地理覆盖范围划分：局域网（LAN）、城域网（MAN）、广域网（WAN）

### 网络拓扑

概念：用传输介质（例如双绞线、光纤等）互联各种设备所呈现的结构化布局，用于描述网络的逻辑结构

形态：星型、总线型、环形、树形、全网状网络和部分网状网络

## 网络工程与网络工程师

网络工程：在信息系统工程方法和完善的组织机构指导下，根据网络应用的需求，按照计算机网络系统的标准、规范和技术，规划设计可行性方案，将计算机网络硬件设备、软件和技术系统地集成在一起，以成为满足用户需求、高性价比的网络系统的组建工作

网络工程师：在网络工程领域，掌握专业的网络技术，具备一定的职业技能及职业素养，具有一定项目实施经验，能够在项目现场与客户或者其他项目干系人充分沟通，根据客户的需求及环境因素指定实施方案及项目计划，并充分调动各方资源保证项目按时、保质保量落地，以及在项目实施后对干系人进行培训及工程文档交付的职业

# 网络参考模型

## 应用和数据

### 应用和数据的定义背景

应用：应用的存在，是为了满足人们的各种需求，比如访问网页，在线游戏，在线视频等。伴随着应用会产生信息，比如文本、图片

数据：在计算机领域，数据是各种信息的载体。大部分应用程序所产生的数据需要在不同的设备间传递

## 网络参考模型与标准协议

### OSI参考模型

应用层：对应用程序提供接口

表示层：进行数据格式的转换，以确保一个系统产生的应用层数据能够被另外一个系统的应用层识别和理解

会话层：在通信双方之间简历、管理和终止会话

传输层：建立、维护和取消一次段导弹的数据传输过程。控制传输节奏的快慢，调整数据的排序等

网络层：定义逻辑地址，实现数据从原到目的地址的转发

数据链路层：将分组数据封装成帧，在数据链路上实现数据的点到点、或点到多点方式的直接通信，差错检测

物理层：在媒介上传输比特流，提供机械和电气的规约

### TCP/IP参考模型与标准协议

因为OSI协议栈比较复杂，且tcp和ip两大协议在业界被广泛使用，所以TCP/IP参考模型成为了互联网的主流参考模型

TCP/IP常见协议：

1. 应用层：
* Telnet(23 TCP)：远程登录协议，提供远程管理服务* 
* FTP(20（传输数据），21（传输控制信息） TCP)：文件传输协议，提供互联网文件资源共享服务，采用C/S架构* 
* TFTP(69 TCP)：文件传输协议，提供简单的文件传输服务* 
* SNMP* 
* HTTP(80 TCP)：超文本传输协议，提供浏览网页服务，采用C/S架构* 
* SMTP(25 TCP)：简单右键传输协议，提供互联网电子邮件服务* 
* DNS* 
* DHCP

2. 传输层：
* 传输层协议接收来自应用层协议的数据，封装相应的传输层头部，帮助其建立端到端的* 接。传输层的PDU被称为段* 
* 传输层的PDU是由应用层数据加伤源端口和目的端口得来的* 
* TCP：面向连接的、可靠的传输层通信协议* 
* UDP：无连接的传输层协议* 
* 客户端使用的源端口一般随机分配，目标端口则由服务器的应用指定* 
* 源端口号一般为系统中未使用的，且大于1023* 
* 目的端口号为服务端开启的应用（服务）所侦听的端口，如HTTP缺省的端口为80

3. 网络层：ICMP，IGMP，IP
* 传输层负责简历主机之间进程与进程之间的连接，而网络层则负责数据从一台主机到另外一台主机之间的传递。网络层的PDU被称为包* 
* 网络层为网络中的设备提供逻辑地址，负责数据包的寻径和转发，常见的协议有IPv4、IPv6、ICMP、ICMP等* 
* 网络层需要维护路由信息，称为路由表* 
* 此层最重要的字段是源IP及目的IP

4. 数据链路层：PPPoE，Ethernet，PPP
* 位于网络层与物理层之间，可以向网络层的IP、IPv6等协议提供服务。数据链路层的PDU被称为帧，以太网是最常见的数据链路层协议* 
* ARP：地址解析协议，根据已知的IP地址解析获得其对应的MAC地址* 
* 此层要加上帧校验（FSC）

5. 物理层
* 数据到达物理层后，物理层会根据物理介质的不同，将数字信号转换成光信号、电信号或电磁波信号。物理层的PDU被称为比特流* 
* 常见传输介质：双绞线、光纤、串口线缆、无线路由器* 
* 此层传输比特流

## 数据通信过程

1. 发送方数据封装：数据，段，包，帧，位

2. 中间网络数据传输

3. 接收方数据解封装：位，帧，包，段，数据
# 网络常用协议

## 传输层

### TCP协议

<div align="center">

![TCP头部](../../../markdown/img/网络/HCIA/TCP头部.jpg)

</div>

**字段解释**：
源/目的端口号：表示数据从哪个进程来，到哪个进程去

序号：TCP将每个字节的数据都进行了编号称为序列号，接收端收到数据之后要发送确认序号给发送端。序号用于对字节流进行编址，例如序号是301，表示第一个字节的编号为301，携带的数据长度是100，下一个报文的编号就是401

确认序号：期望收到的下一个报文段的序号，B收到A发来的一个报文段，序号是301，携带的数据长度是300，那么B发送给A的确认序号就是601

4位头部长度：表示TCP头部有多少个4字节，所以TCP头部最大长度为15*4=60字节

6个标志位：

* URG：紧急指针是否有效- 
* ACK：确认号是否有效- 
* PSH：提示接收端应用程序立刻从缓冲区读走- 
* RST：要求对方重新建立连接，携带RST的标识的报文称为复位报文段- 
* SYN：请求建立连接，携带SYN标识的报文称为同步报文段
* FIN：结束标识，告诉对端本端关闭。

16位窗口大小：无需等待确认应答而可以继续发送数据的最大值

16位校验和：发送端填充，CRC校验，接收端校验不通过，认为数据有问题。校验和包含TCP首部和TCP数据部分。

16位紧急指针：标识那部分数据是紧急数据

**三次握手**：

TCP/IP三次握手是建立TCP连接时所必需的过程。三次握手的目的是确保双方的通信连接是可靠的，以提高数据传输的可靠性。以下是TCP/IP三次握手的过程：

* 客户端向服务端发送SYN请求报文，其中SYN标志位被设为1，客户端进入SYN_SEND状态。

* 服务端收到SYN请求报文后，如果同意请求，则会向客户端发送一个带有SYN和ACK标识位的应答报文(确认号为客户端的序列号+1)，服务端进入SYN_RECV状态。

* 客户端收到带有SYN和ACK标识位的应答报文后，会向服务端发送一个确认报文，其中确认序号为服务端的序列号+1。客户端进入ESTABLISHED状态，服务端也进入ESTABLISHED状态，此时，连接建立成功，可以开始数据传输。
  

```mermaid
sequenceDiagram
    participant client
    participant server
    client->>server: SYN = 1, Seq = x
    server->>client: SYN = 1, ACK = 1, Seq = y, Ack = x + 1
    client->>server: ACK = 1, Seq = x + 1, Ack = y + 1

```

**四次挥手**：

* 主动关闭方发送FIN报文段：表示主动关闭方已经没有数据要发送给被关闭方了。
* 被动关闭方收到FIN报文段并发回ACK报文段：表示被动关闭方已经知主动关闭方没有要发送的数据了，并且可以关闭连接了。
* 被动关闭方也发送FIN报文段：表示被动关闭方也没有数据要发送给主关闭方了。
* 主动关闭方收到FIN报文段并发回ACK报文段：表示主动关闭方也知道动关闭方没有要发送的数据了，连接可以关闭了。

```mermaid

sequenceDiagram
participant A as 主动关闭方
participant B as 被动关闭方
A->>B: FIN报文段（关闭数据发送）
B->>A: ACK报文段（确认收到关闭数据发送请求，但是还有数据要发送）
B->>A: FIN报文段（关闭数据发送）
A->>B: ACK报文段（确认收到关闭数据发送请求，并且连接立即关闭）
```

**窗口滑动机制**：

TCP的窗口滑动是指传输数据时，发送方和接收方维护一个滑动窗口来控制数据流量的传输。发送方在传送数据时，必须等待接收方对已发送数据的确认，才能继续发送数据。接收方在接收到数据时，必须向发送方发送确认，表示已经正确接收了相应的数据。以下是TCP窗口滑动的过程：

* 发送方首先会发送一段数据，并将发送的数据等待接收方的确认。在等待确认期间，发送方维护一个发送窗口，以决定可以发送多少数据。一旦发送数据并等待确认，该数据就会成为发送方滑动窗口中的一部分。

* 接收方在接收数据时，维护一个接收窗口，并发送确认消息。接收方的窗口大小是指接收方为等待确认的数据所分配的缓冲区的大小。当接收方向发送方发送确认时，确认号包含了对已成功接收数据的序列号。

* 发送方在收到接收方的确认后，会将已成功接收的数据从滑动窗口中删除，并根据接收方的窗口大小，更新自己的窗口大小。随着时间的推移，发送方的窗口可能会向前滑动，以允许发送更多数据。

```mermaid
sequenceDiagram
    participant client
    participant server
    loop Window sliding process
        client->>server: Data, Seq = x, Win = w1
        Note over client: Send a window of data
        server->>client: ACK, Ack = x + y, Win = w2
        Note over server: Receive a window of data
        client->>server: Data, Seq = x + y, Win = w3
        Note over client: Send another window of data
    end

```

**流量控制机制**:

TCP/IP的流量控制是通过滑动窗口来实现的，滑动窗口指的是接收方在通信时告诉发送方自己还能接收多少字节的数据的一个窗口大小。发送方需要根据接收方的窗口大小来控制发送的速度，这样即可实现流量控制。

当接收方窗口变小时，发送方需要立刻减少发送的数据量，以便避免拥塞导致的数据包丢失。因此TCP使用连续的序列号来标识接收方所期望的顺序，如果发送方的数据超出接收方的窗口，则会被丢弃。

```mermaid
sequenceDiagram
    participant Client as A
    participant Server as B
    A ->> B: SYN
    B ->> A: SYN+ACK
    A ->> B: ACK
    A ->> B: Data1
    B ->> A: ACK1
    B ->> A: Data2
    B ->> A: Data3
    B ->> A: Data4
    A ->> B: ACK2
    A ->> B: Data5
    B ->> A: ACK3 

```

### UDP协议

<div align="center">

![UDP报文格式](../../img/网络/HCIA/UDP报文格式.png)

</div>

## 网络层

### ARP协议

是网络层协议，工作基于数据链路层

<div align="center">

![ARP报文格式](../../img/网络/HCIA/ARP报文格式.png)

</div>

**字段解释**：

* 以太网目的地址（6Byte）：当发送 ARP 请求时此处全为1(FF: FF: FF: FF: FF: FF)，即为广播地址。当发送 ARP 响应时，此处即为目的端 MAC地址。-
* 以太网源地址（6Byte）：发送 ARP 请求的 MAC 地址，为本机 MAC 地址。
* 帧类型（2Byte）：表示的是后面的数据类型，ARP 请求和 ARP 应答这个值为 0x0806 。
* 硬件类型（2Byte）：硬件地址不只以太网一种，是以太网类型时此值为1。 
* 协议类型（2Byte）：要映射的协议地址的类型，要对IPv4地址进行映射，此值为0x0800。
* 硬件地址长度（1Byte）：即为 MAC 地址长度 6 Byte。
* 协议地址长度（1Byte）：即为 IP 地址长度 4 Byte。
* 操作（2Byte）：值为1，表示进行ARP请求；值为2，表示进行ARP应答；值为3，表示进行RARP请求；值为4，表示进行RARP应答。
* 发送者硬件地址（6Byte）：这是本机的 MAC 地址，与第二个字段相同。
* 发送者 IP 地址（4Byte）：这是本机的 IP 地址。
* 目标硬件地址（6Byte）：在发送 ARP 请求时，还不知道目的端的 MAC 地址，所以此处全为 0 ( 00:00:00:00:00:00 )。当发送 ARP 请求报文是，此处即为目的端 MAC 地址。
* 目标 IP 地址（4Byte）：目标端 IP 地址。

### ICMP协议

常用于测试网络连通性的协议，常用命令有： `ping` ， `tracert`

### IP协议

<div align="center">

![ipv4报文格式](../../img/网络/HCIA/ipv4报文格式.png)

</div>

**字段解释**:

* 版本（Version）：这个字段指定了使用的IP协议版本，通常是IPv4或IPv6。

* 头部长度（Header Length）：这个字段指定了IP头部的长度。IP头部通常是20个字节，但是如果选项字段被用到了，那么头部长度可以会更大。这个字节只有4bit，实际应用中，为了使其能表示20-60这个范围，约定俗成需要将其值乘以4

* 服务类型（Type of Service）：这个字段可以用来指定IP包的服务类型。这个字段包括了对不同数据流的不同服务质量的定义，如低延迟、高带宽和可靠传输等等。

* 总长度（Total Length）：这个字段指定了IP包的总长度，当IP层的数据包太大时，可能需要进行分片操作。

* 标识（Identification）：这个字段唯一标识IP包并用于将分片的数据包重新组合。

* 标志（Flags）：这个字段被用来标识分片。一个标志位用于表示是否还有更多的分片存在，另一个标志位用于表示当前分片是不是第一个分片。

* 片偏移（Fragment Offset）：这个字段指定了当前IP分片相对于整个数据包的偏移量。

* 生存时间（Time to Live）：这个字段指定了IP包在到达目标之前可以转发的最大路由数，每经过一个路由器，此值会减少一。

* 协议（Protocol）：这个字段指定了IP包所使用的传输层协议，如TCP、UDP和ICMP等等。

* 头部校验和（Header Checksum）：这个字段是一个用于检测IP数据包头部有没有变动的校验和，如果有变动则需要舍弃这个IP包。

* 源地址（Source Address）：这个字段指定了发送IP包的原始IP地址。

* 目的地址（Destination Address）：这个字段指定了接收IP包的IP地址。
